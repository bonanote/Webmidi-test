<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple WebMIDI Tester</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #1e1e1e;
            color: #e0e0e0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            box-sizing: border-box;
        }

        h2 { margin-top: 0; }

        .controls {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 600px;
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }

        select {
            padding: 8px;
            background: #3e3e3e;
            color: white;
            border: 1px solid #555;
            border-radius: 4px;
            flex-grow: 1;
        }

        button {
            padding: 8px 16px;
            background-color: #007acc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover { background-color: #005f9e; }
        button:disabled { background-color: #555; cursor: not-allowed; }

        #log-window {
            background: #000;
            color: #00ff00;
            font-family: 'Courier New', Courier, monospace;
            width: 100%;
            max-width: 600px;
            flex-grow: 1;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 14px;
        }

        .log-entry { margin-bottom: 2px; border-bottom: 1px solid #111; }
        .header { color: #888; font-size: 0.8em; margin-bottom: 10px; }
    </style>
</head>
<body>

    <h2>WebMIDI Input Tester</h2>

    <div class="controls">
        <button id="btn-request">1. Start / Request Access</button>
        <select id="midi-input" disabled>
            <option value="">-- Select Controller --</option>
        </select>
        <button id="btn-clear">Clear Log</button>
    </div>

    <div class="header">Format: [Status Byte] [Data Byte 1] [Data Byte 2]</div>
    <div id="log-window">Waiting for MIDI input...</div>

    <script>
        let midi = null; // Global MIDI access object
        let activeInput = null;

        const btnRequest = document.getElementById('btn-request');
        const select = document.getElementById('midi-input');
        const logWindow = document.getElementById('log-window');
        const btnClear = document.getElementById('btn-clear');

        // 1. Request MIDI Access
        btnRequest.addEventListener('click', () => {
            if (navigator.requestMIDIAccess) {
                navigator.requestMIDIAccess()
                    .then(onMIDISuccess, onMIDIFailure);
            } else {
                log("WebMIDI is not supported in this browser.");
            }
        });

        // 2. Handle Success
        function onMIDISuccess(midiAccess) {
            midi = midiAccess;
            log("MIDI Access Granted.");
            btnRequest.disabled = true;
            btnRequest.textContent = "Access Granted";
            select.disabled = false;
            
            updateInputList();

            // Listen for connection changes (plugging/unplugging devices)
            midi.onstatechange = updateInputList;
        }

        function onMIDIFailure() {
            log("Could not access your MIDI devices.");
        }

        // 3. Populate Dropdown
        function updateInputList() {
            // Save current selection if it exists
            const previousSelection = select.value;
            
            // Clear existing options
            select.innerHTML = '<option value="">-- Select Controller --</option>';
            
            const inputs = midi.inputs.values();
            for (let input of inputs) {
                const option = document.createElement('option');
                option.value = input.id;
                option.text = input.name || "Unknown Device";
                select.appendChild(option);
            }

            // Restore selection if device is still there
            if (previousSelection) {
                select.value = previousSelection;
            }
        }

        // 4. Handle Input Selection
        select.addEventListener('change', (e) => {
            // Cleanup previous listener
            if (activeInput) {
                activeInput.onmidimessage = null;
            }

            const id = e.target.value;
            if (id && midi) {
                activeInput = midi.inputs.get(id);
                activeInput.onmidimessage = onMIDIMessage;
                log(`Listening to: ${activeInput.name}`);
            }
        });

        // 5. The Core Logic: Receiving Data
        function onMIDIMessage(message) {
            const data = message.data; // The raw MIDI bytes (e.g., [144, 60, 100])
            const command = data[0];
            const note = data[1];
            const velocity = (data.length > 2) ? data[2] : 0;

            // Simple interpretation strings
            let type = "Unknown";
            // Mask the channel to get the message type (0xF0 is the mask)
            const cmdType = command & 0xF0; 

            if (cmdType === 144) type = "Note On";
            if (cmdType === 128) type = "Note Off";
            if (cmdType === 176) type = "Control Change";
            if (cmdType === 224) type = "Pitch Bend";

            // Format the output string
            const output = `RAW: [${data}] | TYPE: ${type} | Note/CC: ${note} | Val/Vel: ${velocity}`;
            
            log(output);
        }

        // Helper: Logging to screen
        function log(msg) {
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.textContent = msg;
            logWindow.appendChild(div);
            // Auto-scroll to bottom
            logWindow.scrollTop = logWindow.scrollHeight;
        }

        // Helper: Clear log
        btnClear.addEventListener('click', () => {
            logWindow.innerHTML = '';
        });

    </script>
</body>
</html>
